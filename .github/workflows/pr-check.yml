name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'

permissions:
  contents: read

concurrency:
  group: pr-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files_yaml: |
            python:
              - '**/*.py'
              - 'requirements.txt'
              - 'pyproject.toml'
              - 'setup.cfg'
              - 'setup.py'
            infra:
              - 'infrastructure/**'
            node:
              - 'package.json'
              - 'package-lock.json'
              - 'npm-shrinkwrap.json'
              - 'yarn.lock'

      - name: Setup Python
        if: ${{ steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.infra_any_changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        if: ${{ steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.infra_any_changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare Python file list
        if: ${{ steps.changed-files.outputs.python_any_changed == 'true' }}
        env:
          PY_FILES: ${{ steps.changed-files.outputs.python_files }}
        run: |
          python - <<'PY' > .changed-python-files
          import json
          import os
          import sys

          files = json.loads(os.environ.get('PY_FILES', '[]'))
          sys.stdout.write("\n".join(files))
          PY

      - name: Run pre-commit on changed Python files
        if: ${{ steps.changed-files.outputs.python_any_changed == 'true' }}
        run: |
          if [ ! -s .changed-python-files ]; then
            exit 0
          fi
          mapfile -t PY_CHANGED < .changed-python-files
          if [ ${#PY_CHANGED[@]} -eq 0 ]; then
            exit 0
          fi
          pre-commit run --show-diff-on-failure --files "${PY_CHANGED[@]}"

      - name: Type check (mypy)
        if: ${{ steps.changed-files.outputs.python_any_changed == 'true' }}
        run: |
          if [ ! -s .changed-python-files ]; then
            echo "No changed Python files. Skipping mypy."
            exit 0
          fi
          mapfile -t PY_CHANGED < .changed-python-files
          if [ ${#PY_CHANGED[@]} -eq 0 ]; then
            echo "No changed Python files. Skipping mypy."
            exit 0
          fi
          python -m mypy "${PY_CHANGED[@]}"

      - name: Setup Node.js (infra changed, cache)
        if: ${{ steps.changed-files.outputs.infra_any_changed == 'true' && hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json', '**/yarn.lock') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Node.js (infra changed, no lockfile)
        if: ${{ steps.changed-files.outputs.infra_any_changed == 'true' && hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json', '**/yarn.lock') == '' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Node deps (infra changed)
        if: ${{ steps.changed-files.outputs.infra_any_changed == 'true' && hashFiles('**/package-lock.json') != '' }}
        run: npm ci

      - name: Install CDK CLI (infra changed, no lockfile)
        if: ${{ steps.changed-files.outputs.infra_any_changed == 'true' && hashFiles('**/package-lock.json') == '' }}
        run: npm install --no-save aws-cdk@latest

      - name: CDK synth (infra changed)
        if: ${{ steps.changed-files.outputs.infra_any_changed == 'true' }}
        run: |
          echo "ðŸ—ï¸ Validating CDK infrastructure..."
          npx cdk synth --context environment=dev

  tests:
    uses: ./.github/workflows/ci.yml
    with:
      python-version: "${{ env.PYTHON_VERSION }}"
      run-precommit: false
    secrets: inherit
