name: PR Check

on:
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'

jobs:
  quick-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Check changes
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files: $(echo "$CHANGED" | wc -l)"
          
          # Quick format check on changed Python files
          CHANGED_PY=$(echo "$CHANGED" | grep "\.py$" || true)
          INFRA_CHANGED=$(echo "$CHANGED" | grep -E "(infrastructure/|app\.py)" > /dev/null && echo "true" || echo "false")
          
          # Install requirements once if needed
          if [[ -n "$CHANGED_PY" || "$INFRA_CHANGED" == "true" ]]; then
            pip install -r requirements.txt
          fi
          
          if [[ -n "$CHANGED_PY" ]]; then
            pip install black flake8
            echo "$CHANGED_PY" | xargs black --check --diff || {
              echo "❌ Fix formatting: black $(echo $CHANGED_PY | tr '\n' ' ')"
              exit 1
            }
            echo "$CHANGED_PY" | xargs flake8 --max-line-length=88 --extend-ignore=E203,W503 || {
              echo "❌ Fix linting issues"
              exit 1
            }
          fi
          
          # CDK syntax check if infrastructure changed
          if [[ "$INFRA_CHANGED" == "true" ]]; then
            
            # Install Node.js and CDK
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs
            npm install -g aws-cdk@latest
            
            cdk synth --context environment=dev || {
              echo "❌ CDK syntax error detected"
              exit 1
            }
          fi
          
          echo "✅ PR checks passed"