# Raw Data Schema — S3 저장 스키마 명세

본 문서는 Extract 파이프라인에서 생성하는 Raw 데이터의 스키마, S3 저장 구조, 파티셔닝 전략을 정의합니다. 이 스키마는 Transform 단계의 입력으로 사용됩니다.

## S3 버킷 구조

### 버킷 설정

| 항목 | 값 | 설명 |
|------|-----|------|
| **버킷명 패턴** | `data-pipeline-raw-{environment}-{account-suffix}` | 환경별 분리 |
| **리전** | `us-east-1` | Transform과 동일 리전 |
| **암호화** | AES256 (SSE-S3) | 저장 데이터 암호화 |
| **버전 관리** | ✅ 활성화 | 실수 삭제 방지 |
| **수명 주기** | 90일 → IA, 365일 → Glacier | 비용 최적화 |

### 디렉토리 구조 (Hive 파티셔닝)

```
s3://{RAW_BUCKET}/
├── {domain}/                     # 비즈니스 도메인
│   └── {table_name}/             # 데이터셋/테이블
│       └── ingestion_date={YYYY-MM-DD}/  # 수집 날짜
│           └── data_source={source}/      # 데이터 소스
│               └── symbol={symbol}/       # 금융 심볼
│                   └── interval={interval}/  # 시간 간격
│                       └── period={period}/  # 조회 기간
│                           └── {timestamp}.{ext}  # 실제 파일
```

### 파티션 키 성능 분석

| 파티션 레벨 | 키 | 카디널리티 | 쿼리 효율성 | Athena 최적화 | 예시 |
|:----------:|---|:----------:|:-----------:|:-------------:|------|
| **1** | domain | 낮음 (10개) | ⭐⭐⭐ | 매우 높음 | `market` |
| **2** | table_name | 낮음 (50개) | ⭐⭐⭐ | 매우 높음 | `prices` |
| **3** | ingestion_date | 높음 (일별) | ⭐⭐⭐⭐⭐ | 최고 | `2025-09-09` |
| **4** | data_source | 낮음 (5개) | ⭐⭐⭐ | 높음 | `yahoo_finance` |
| **5** | symbol | 매우 높음 (1000+) | ⭐⭐⭐⭐ | 높음 | `AAPL` |
| **6** | interval | 낮음 (15개) | ⭐⭐ | 중간 | `1d` |
| **7** | period | 낮음 (10개) | ⭐ | 낮음 | `1mo` |

## 데이터 스키마

### Price Record 필드 명세

| 필드명 | 데이터 타입 | 널 허용 | 제약 조건 | 설명 | 예시 |
|--------|-------------|:-------:|----------|------|------|
| **symbol** | `string` | ❌ | 1-20자, 영숫자 및 `.`, `-` | 금융 상품 심볼 | `AAPL`, `BRK.B` |
| **timestamp** | `timestamp` | ❌ | ISO 8601, UTC | 데이터 포인트 시각 | `2025-09-09T09:30:00Z` |
| **open** | `decimal(10,2)` | ✅ | ≥ 0 | 시가 | `150.25` |
| **high** | `decimal(10,2)` | ✅ | ≥ 0 | 고가 | `152.10` |
| **low** | `decimal(10,2)` | ✅ | ≥ 0 | 저가 | `149.80` |
| **close** | `decimal(10,2)` | ✅ | ≥ 0 | 종가 | `151.45` |
| **volume** | `bigint` | ✅ | ≥ 0 | 거래량 | `1234567` |
| **adj_close** | `decimal(10,2)` | ✅ | ≥ 0 | 수정 종가 | `151.45` |

### 데이터 타입 매핑

| 형식 | Symbol | Timestamp | Price Fields | Volume |
|------|--------|-----------|--------------|--------|
| **JSON** | `string` | `string (ISO 8601)` | `number` | `integer` |
| **CSV** | `text` | `text` | `text` | `text` |
| **Parquet** | `BINARY (UTF8)` | `TIMESTAMP_MILLIS` | `DOUBLE` | `INT64` |
| **Athena** | `string` | `timestamp` | `decimal(10,2)` | `bigint` |

## 파일 형식

### 파일 형식별 특성 비교

| 형식 | 확장자 | 압축률 | 호환성 | 쿼리 성능 | 스토리지 비용 | 권장 용도 |
|------|--------|:------:|:------:|:---------:|:-----------:|----------|
| **JSON Lines** | `.json` | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 기본값, 개발 친화적 |
| **CSV** | `.csv` | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ | Excel 호환, 수동 분석 |
| **Parquet** | `.parquet` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 대용량 분석 (미래) |

### 파일 크기 가이드라인

| 형식 | 목표 크기 | 최대 크기 | 심볼당 30일 예상 | Athena 최적화 |
|------|:---------:|:---------:|:---------------:|:-------------:|
| **JSON** | 1-10MB | 50MB | ~9MB | ⭐⭐⭐ |
| **CSV** | 1-5MB | 25MB | ~6MB | ⭐⭐ |
| **Parquet** | 10-100MB | 200MB | ~3MB | ⭐⭐⭐⭐⭐ |

### 파일명 규칙

| 구성 요소 | 형식 | 예시 | 설명 |
|----------|------|------|------|
| **Timestamp** | `YYYY-MM-DDTHH-MM-SSZ` | `2025-09-09T14-30-45Z` | UTC 기준, 콜론 제외 (S3 호환) |
| **Extension** | `.{format}` | `.json`, `.csv`, `.parquet` | 형식별 확장자 |

## 파티셔닝 전략

### Athena 쿼리 패턴별 최적화

| 쿼리 패턴 | 파티션 활용 | 성능 지수 | 비용 효율성 | 예시 쿼리 |
|----------|-------------|:---------:|:-----------:|----------|
| **일별 데이터** | `ingestion_date` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | `WHERE ingestion_date='2025-09-09'` |
| **심볼별 분석** | `symbol` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | `WHERE symbol='AAPL'` |
| **도메인별 조회** | `domain` | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | `WHERE domain='market'` |
| **소스별 필터** | `data_source` | ⭐⭐⭐ | ⭐⭐⭐ | `WHERE data_source='yahoo_finance'` |

### 파티션 프루닝 효과

| 파티션 조합 | 스캔 데이터 감소 | 쿼리 시간 단축 | 비용 절감 | 권장도 |
|------------|:---------------:|:-------------:|:---------:|:------:|
| **날짜 + 심볼** | 99.9% | 95% | 99.9% | ⭐⭐⭐⭐⭐ |
| **날짜 + 도메인** | 99% | 90% | 99% | ⭐⭐⭐⭐ |
| **날짜만** | 99% | 80% | 99% | ⭐⭐⭐ |
| **심볼만** | 90% | 70% | 90% | ⭐⭐ |

## 데이터 품질

### 검증 규칙 체크리스트

| 검증 항목 | 조건 | 액션 | 로그 레벨 | 자동 복구 |
|----------|------|------|----------|:--------:|
| **필수 필드 존재** | `symbol`, `timestamp` 존재 | 레코드 스킵 | ERROR | ❌ |
| **심볼 형식** | 정규식 `^[A-Z0-9._-]{1,20}$` | 레코드 스킵 | WARNING | ❌ |
| **타임스탬프 형식** | ISO 8601 UTC | 레코드 스킵 | ERROR | ❌ |
| **가격 범위** | ≥ 0 | 경고 후 계속 | WARNING | ✅ |
| **볼륨 범위** | ≥ 0 | 경고 후 계속 | WARNING | ✅ |
| **중복 레코드** | 같은 심볼+시각 | 나중 레코드 유지 | INFO | ✅ |

### S3 메타데이터 태깅

| 태그 키 | 값 예시 | 용도 | 자동 생성 |
|---------|---------|------|:-------:|
| `ingestion_timestamp` | `2025-09-09T14:30:45Z` | 추적 | ✅ |
| `data_source` | `yahoo_finance` | 필터링 | ✅ |
| `symbol_count` | `3` | 통계 | ✅ |
| `record_count` | `90` | 통계 | ✅ |
| `file_format` | `json` | 타입 식별 | ✅ |
| `environment` | `dev` | 환경 구분 | ✅ |

## 압축 정책

### 압축 전략 비교

| 압축 방식 | 압축률 | CPU 사용량 | 권장 용도 |
|----------|:------:|:---------:|----------|
| **GZIP (기본)** | 75-80% | ⭐⭐⭐ | JSON, CSV |
| **ZSTD** | 80-85% | ⭐⭐ | 대용량 JSON |
| **Parquet SNAPPY** | 85-90% | ⭐⭐⭐⭐ | Parquet 전용 |
| **압축 없음** | 0% | ⭐⭐⭐⭐⭐ | 개발/테스트 |

### 환경별 압축 설정

| 환경 | JSON 압축 | CSV 압축 | Parquet 압축 | 근거 |
|------|:---------:|:---------:|:------------:|------|
| **dev** | ❌ | ❌ | ❌ | 디버깅 편의성 |
| **staging** | ✅ GZIP | ✅ GZIP | ✅ SNAPPY | 운영 환경 테스트 |
| **prod** | ✅ GZIP | ✅ GZIP | ✅ SNAPPY | 비용 최적화 |

---

*본 명세는 `src/lambda/layers/common/python/shared/ingestion/service.py`의 데이터 구조와 `src/lambda/layers/common/python/shared/models/` 스키마를 기반으로 작성되었습니다.*