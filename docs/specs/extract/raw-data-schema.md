# Raw Data Schema — S3 저장 스키마 명세

본 문서는 Extract 파이프라인에서 생성하는 Raw 데이터의 스키마, S3 저장 구조, 파티셔닝 전략, 그리고 데이터 형식을 정의합니다. 이 스키마는 Transform 단계의 입력 데이터로 사용됩니다.

## 📖 목차
- [S3 버킷 구조](#s3-버킷-구조)
- [데이터 스키마](#데이터-스키마)
- [파일 형식](#파일-형식)
- [파티셔닝 전략](#파티셔닝-전략)
- [데이터 품질](#데이터-품질)
- [압축 정책](#압축-정책)
- [스키마 진화](#스키마-진화)
- [성능 최적화](#성능-최적화)

## S3 버킷 구조

### 버킷 명명 및 설정

| 항목 | 값 | 설명 |
|------|-----|------|
| **버킷명 패턴** | `data-pipeline-raw-{environment}-{account-suffix}` | 환경별 분리 |
| **리전** | `us-east-1` | Transform과 동일 리전 |
| **암호화** | AES256 (SSE-S3) | 저장 데이터 암호화 |
| **버전 관리** | ✅ 활성화 | 실수 삭제 방지 |
| **수명 주기** | 90일 → IA, 365일 → Glacier | 비용 최적화 |
| **접근 로깅** | ✅ 활성화 | 감사 추적 |

### 디렉토리 구조 (Hive 파티셔닝)

```
s3://{RAW_BUCKET}/
├── {domain}/                     # 비즈니스 도메인
│   └── {table_name}/             # 데이터셋/테이블
│       └── ingestion_date={YYYY-MM-DD}/  # 수집 날짜
│           └── data_source={source}/      # 데이터 소스
│               └── symbol={symbol}/       # 금융 심볼
│                   └── interval={interval}/  # 시간 간격
│                       └── period={period}/  # 조회 기간
│                           └── {timestamp}.{ext}  # 실제 파일
```

### 파티션 키 성능 분석

| 파티션 레벨 | 키 | 카디널리티 | 쿼리 효율성 | Athena 최적화 | 예시 |
|:----------:|---|:----------:|:-----------:|:-------------:|------|
| **1** | domain | 낮음 (10개) | ⭐⭐⭐ | 매우 높음 | `market` |
| **2** | table_name | 낮음 (50개) | ⭐⭐⭐ | 매우 높음 | `prices` |
| **3** | ingestion_date | 높음 (일별) | ⭐⭐⭐⭐⭐ | 최고 | `2025-09-09` |
| **4** | data_source | 낮음 (5개) | ⭐⭐⭐ | 높음 | `yahoo_finance` |
| **5** | symbol | 매우 높음 (1000+) | ⭐⭐⭐⭐ | 높음 | `AAPL` |
| **6** | interval | 낮음 (15개) | ⭐⭐ | 중간 | `1d` |
| **7** | period | 낮음 (10개) | ⭐ | 낮음 | `1mo` |

## 데이터 스키마

### Price Record 필드 명세

| 필드명 | 데이터 타입 | 널 허용 | 제약 조건 | 설명 | 예시 |
|--------|-------------|:-------:|----------|------|------|
| **symbol** | `string` | ❌ | 1-20자, 영숫자 및 `.`, `-` | 금융 상품 심볼 | `AAPL`, `BRK.B` |
| **timestamp** | `timestamp` | ❌ | ISO 8601, UTC | 데이터 포인트 시각 | `2025-09-09T09:30:00Z` |
| **open** | `decimal(10,2)` | ✅ | ≥ 0 | 시가 | `150.25` |
| **high** | `decimal(10,2)` | ✅ | ≥ 0 | 고가 | `152.10` |
| **low** | `decimal(10,2)` | ✅ | ≥ 0 | 저가 | `149.80` |
| **close** | `decimal(10,2)` | ✅ | ≥ 0 | 종가 | `151.45` |
| **volume** | `bigint` | ✅ | ≥ 0 | 거래량 | `1234567` |
| **adj_close** | `decimal(10,2)` | ✅ | ≥ 0 | 수정 종가 | `151.45` |

### 데이터 타입 매핑

| 형식 | Symbol | Timestamp | Price Fields | Volume | 설명 |
|------|--------|-----------|--------------|--------|------|
| **JSON** | `string` | `string (ISO 8601)` | `number` | `integer` | 웹 호환성 최고 |
| **CSV** | `text` | `text` | `text` | `text` | Excel 호환성 |
| **Parquet** | `BINARY (UTF8)` | `TIMESTAMP_MILLIS` | `DOUBLE` | `INT64` | 압축률 최고 |
| **Athena** | `string` | `timestamp` | `decimal(10,2)` | `bigint` | 쿼리 최적화 |

## 파일 형식

### 파일 형식별 특성 비교

| 형식 | 확장자 | 압축률 | 호환성 | 쿼리 성능 | 스토리지 비용 | 권장 용도 |
|------|--------|:------:|:------:|:---------:|:-----------:|----------|
| **JSON Lines** | `.json` | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 기본값, 개발 친화적 |
| **CSV** | `.csv` | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ | Excel 호환, 수동 분석 |
| **Parquet** | `.parquet` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 대용량 분석 (미래) |

### 파일 크기 가이드라인

| 형식 | 목표 크기 | 최대 크기 | 심볼당 30일 예상 | Athena 최적화 | 전송 효율성 |
|------|:---------:|:---------:|:---------------:|:-------------:|:-----------:|
| **JSON** | 1-10MB | 50MB | ~9MB | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **CSV** | 1-5MB | 25MB | ~6MB | ⭐⭐ | ⭐⭐⭐ |
| **Parquet** | 10-100MB | 200MB | ~3MB | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

### 파일명 규칙

| 구성 요소 | 형식 | 예시 | 설명 |
|----------|------|------|------|
| **Timestamp** | `YYYY-MM-DDTHH-MM-SSZ` | `2025-09-09T14-30-45Z` | UTC 기준, 콜론 제외 (S3 호환) |
| **Extension** | `.{format}` | `.json`, `.csv`, `.parquet` | 형식별 확장자 |
| **Full Path** | `{path}/{timestamp}.{ext}` | `market/prices/.../2025-09-09T14-30-45Z.json` | 전체 경로 |

## 파티셔닝 전략

### Athena 쿼리 패턴별 최적화

| 쿼리 패턴 | 파티션 활용 | 성능 지수 | 비용 효율성 | 예시 쿼리 |
|----------|-------------|:---------:|:-----------:|----------|
| **일별 데이터** | `ingestion_date` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | `WHERE ingestion_date='2025-09-09'` |
| **심볼별 분석** | `symbol` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | `WHERE symbol='AAPL'` |
| **도메인별 조회** | `domain` | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | `WHERE domain='market'` |
| **기간별 비교** | `interval` | ⭐⭐ | ⭐⭐⭐ | `WHERE interval='1d'` |
| **소스별 필터** | `data_source` | ⭐⭐⭐ | ⭐⭐⭐ | `WHERE data_source='yahoo_finance'` |

### 파티션 프루닝 효과

| 파티션 조합 | 스캔 데이터 감소 | 쿼리 시간 단축 | 비용 절감 | 권장도 |
|------------|:---------------:|:-------------:|:---------:|:------:|
| **날짜 + 심볼** | 99.9% | 95% | 99.9% | ⭐⭐⭐⭐⭐ |
| **날짜 + 도메인** | 99% | 90% | 99% | ⭐⭐⭐⭐ |
| **날짜만** | 99% | 80% | 99% | ⭐⭐⭐ |
| **심볼만** | 90% | 70% | 90% | ⭐⭐ |

## 데이터 품질

### 검증 규칙 체크리스트

| 검증 항목 | 조건 | 액션 | 로그 레벨 | 자동 복구 |
|----------|------|------|----------|:--------:|
| **필수 필드 존재** | `symbol`, `timestamp` 존재 | 레코드 스킵 | ERROR | ❌ |
| **심볼 형식** | 정규식 `^[A-Z0-9._-]{1,20}$` | 레코드 스킵 | WARNING | ❌ |
| **타임스탬프 형식** | ISO 8601 UTC | 레코드 스킵 | ERROR | ❌ |
| **가격 범위** | ≥ 0 | 경고 후 계속 | WARNING | ✅ |
| **볼륨 범위** | ≥ 0 | 경고 후 계속 | WARNING | ✅ |
| **NULL 패턴** | 연속 NULL > 5개 | 경고 후 계속 | WARNING | ❌ |
| **중복 레코드** | 같은 심볼+시각 | 나중 레코드 유지 | INFO | ✅ |

### 이상 데이터 탐지

| 이상 유형 | 탐지 조건 | 임계값 | 알람 | 자동 조치 |
|----------|----------|:------:|:----:|:-------:|
| **가격 급변** | 전일 대비 ±50% | 심볼별 설정 | ⚠️ | 로그만 |
| **거래량 급증** | 평균 대비 10배 | 10배 | ⚠️ | 로그만 |
| **데이터 부재** | 예상 레코드 수 < 50% | 50% | 🚨 | 재수집 트리거 |
| **타임스탬프 이상** | 미래/과거 데이터 | ±7일 | ⚠️ | 로그만 |

### S3 메타데이터 태깅

| 태그 키 | 값 예시 | 용도 | 자동 생성 |
|---------|---------|------|:-------:|
| `ingestion_timestamp` | `2025-09-09T14:30:45Z` | 추적 | ✅ |
| `data_source` | `yahoo_finance` | 필터링 | ✅ |
| `symbol_count` | `3` | 통계 | ✅ |
| `record_count` | `90` | 통계 | ✅ |
| `file_format` | `json` | 타입 식별 | ✅ |
| `environment` | `dev` | 환경 구분 | ✅ |
| `data_quality` | `valid` | 품질 상태 | ✅ |

## 압축 정책

### 압축 전략 비교

| 압축 방식 | 압축률 | CPU 사용량 | 압축 시간 | 해제 시간 | 권장 용도 |
|----------|:------:|:---------:|:---------:|:---------:|----------|
| **GZIP (기본)** | 75-80% | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | JSON, CSV |
| **ZSTD** | 80-85% | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 대용량 JSON |
| **Parquet SNAPPY** | 85-90% | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Parquet 전용 |
| **압축 없음** | 0% | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 개발/테스트 |

### 환경별 압축 설정

| 환경 | JSON 압축 | CSV 압축 | Parquet 압축 | 근거 |
|------|:---------:|:---------:|:------------:|------|
| **dev** | ❌ | ❌ | ❌ | 디버깅 편의성 |
| **staging** | ✅ GZIP | ✅ GZIP | ✅ SNAPPY | 운영 환경 테스트 |
| **prod** | ✅ GZIP | ✅ GZIP | ✅ SNAPPY | 비용 최적화 |

## 스키마 진화

### 호환성 유형별 전략

| 변경 유형 | 호환성 | 마이그레이션 | 버전 관리 | 예시 |
|----------|:------:|:----------:|:---------:|------|
| **필드 추가** | ✅ Backward | 불필요 | Minor | `dividend_yield` 필드 추가 |
| **선택 필드 제거** | ⚠️ Forward | 점진적 | Minor | `adj_close` 필드 제거 |
| **필수 필드 추가** | ❌ Breaking | 필수 | Major | 새 필수 필드 |
| **타입 변경** | ❌ Breaking | 필수 | Major | `volume` string → integer |
| **필드명 변경** | ❌ Breaking | 필수 | Major | `close` → `closing_price` |

### 스키마 버전 관리

| 버전 | 변경 내용 | 호환성 | 배포 전략 | 롤백 계획 |
|:----:|----------|:------:|----------|----------|
| **v1.0** | 초기 스키마 | - | 전체 배포 | N/A |
| **v1.1** | `adj_close` 추가 | Backward | 점진적 | 필드 무시 |
| **v1.2** | `dividend_yield` 추가 | Backward | 점진적 | 필드 무시 |
| **v2.0** | `volume` 타입 변경 | Breaking | Blue-Green | 이전 버전 롤백 |

## 성능 최적화

### Athena 쿼리 최적화

| 최적화 기법 | 적용 방법 | 성능 향상 | 비용 절감 | 구현 복잡도 |
|------------|----------|:---------:|:---------:|:-----------:|
| **파티션 프루닝** | WHERE 절에 파티션 키 | 95% | 99% | ⭐ |
| **컬럼형 형식** | Parquet 사용 | 70% | 70% | ⭐⭐⭐ |
| **압축 적용** | GZIP/SNAPPY | 30% | 50% | ⭐⭐ |
| **파일 크기 최적화** | 128MB 목표 | 20% | 10% | ⭐⭐⭐ |
| **프로젝션 사용** | 필요 컬럼만 선택 | 50% | 80% | ⭐ |

### S3 Access 패턴 최적화

| 패턴 | 빈도 | 최적화 전략 | Storage Class | 예상 비용 |
|------|:----:|------------|:-------------:|:---------:|
| **최근 7일** | 높음 | Standard | STANDARD | $23/TB |
| **8-30일** | 중간 | Intelligent Tiering | STANDARD_IA | $12.5/TB |
| **31-90일** | 낮음 | 자동 전환 | STANDARD_IA | $12.5/TB |
| **91일+** | 매우 낮음 | Lifecycle Policy | GLACIER | $4/TB |
| **1년+** | 거의 없음 | Deep Archive | DEEP_ARCHIVE | $1/TB |

### 쿼리 성능 벤치마크

| 쿼리 유형 | 데이터 크기 | 파티션 활용 | 실행 시간 | 스캔 데이터 | 비용 |
|----------|:----------:|:-----------:|:---------:|:-----------:|:----:|
| **일별 심볼 조회** | 1GB | 완전 활용 | 2초 | 1MB | $0.005 |
| **월별 집계** | 100GB | 부분 활용 | 15초 | 100MB | $0.50 |
| **전체 심볼 스캔** | 1TB | 미활용 | 120초 | 1TB | $5.00 |

---

*본 명세는 `src/lambda/layers/common/python/shared/ingestion/service.py`의 데이터 구조와 `src/lambda/layers/common/python/shared/models/` 스키마를 기반으로 작성되었습니다.*