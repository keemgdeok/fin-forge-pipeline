# SQS Integration — 메시지 큐 통합 명세

본 문서는 Extract 파이프라인에서 사용하는 Amazon SQS 큐 설계, 메시지 형식, 배치 처리, 그리고 재시도 정책을 정의합니다. SQS는 Orchestrator Lambda와 Worker Lambda 간의 비동기 통신 계층을 제공합니다.

## 📖 목차
- [큐 아키텍처](#큐-아키텍처)
- [큐 설정 명세](#큐-설정-명세)
- [메시지 형식](#메시지-형식)
- [배치 처리](#배치-처리)
- [재시도 및 오류 처리](#재시도-및-오류-처리)
- [모니터링](#모니터링)
- [비용 최적화](#비용-최적화)
- [장애 시나리오](#장애-시나리오)

## 큐 아키텍처

Extract 파이프라인은 **Main Queue + Dead Letter Queue** 패턴을 사용합니다.

### 큐 구성 개요

| 큐 타입 | 이름 패턴 | 용도 | 라이프사이클 | 접근 권한 |
|---------|-----------|------|--------------|-----------|
| **Main Queue** | `{environment}-ingestion-queue` | 정상 메시지 처리 | 14일 보관 | Orchestrator(Write), Worker(Read) |
| **Dead Letter Queue** | `{environment}-ingestion-dlq` | 실패 메시지 격리 | 14일 보관 | 수동 복구용 (Read Only) |

## 큐 설정 명세

### Main Queue vs DLQ 상세 비교

| 설정 항목 | Main Queue | Dead Letter Queue | 근거 |
|----------|------------|-------------------|------|
| **Queue Type** | Standard | Standard | 순서 보장 불필요 |
| **Visibility Timeout** | 1800초 (30분) | 300초 (5분) | Worker 처리시간 vs 수동 처리 |
| **Message Retention** | 14일 | 14일 | AWS 기본값 유지 |
| **Receive Wait Time** | 0초 (단시간 폴링) | 20초 (장시간 폴링) | Lambda 최적화 vs 수동 처리 |
| **Max Receive Count** | 5회 | ∞ | DLQ 이동 조건 vs 영구 보관 |
| **Delivery Delay** | 0초 | 0초 | 즉시 처리 |
| **Max Message Size** | 256KB | 256KB | SQS 기본 제한 |
| **KMS Encryption** | ✅ (기본키) | ✅ (기본키) | 저장 데이터 암호화 |
| **SSL Enforcement** | ✅ | ✅ | 전송 중 암호화 |

### 환경별 설정 차이

| 환경 | Main Queue Timeout | DLQ 알람 임계값 | Batch Size | 근거 |
|------|-------------------|-----------------|------------|------|
| **dev** | 1800초 | 10개 | 1-5 | 디버깅 편의성 |
| **staging** | 1800초 | 5개 | 5-10 | 운영 환경 유사 |
| **prod** | 1800초 | 1개 | 10 | 최대 성능 + 즉시 알람 |

## 메시지 형식

### 메시지 구조 명세

| 구성 요소 | 크기 제한 | 형식 | 설명 | 예시 |
|----------|-----------|------|------|------|
| **Message Body** | 256KB | JSON 문자열 | 실제 페이로드 데이터 | `{"data_source":"yahoo_finance",...}` |
| **Message Attributes** | 10개, 각 256B | Key-Value | 메타데이터 (선택) | `source=orchestrator` |
| **Message ID** | - | UUID | SQS 자동 생성 | `12345678-1234-...` |
| **Receipt Handle** | - | String | 메시지 삭제용 핸들 | `AQEB1...` |

### Message Body 필드 상세

| 필드 | 타입 | 크기 | 필수 | 검증 규칙 | 기본값 |
|------|------|:----:|:---:|----------|--------|
| **data_source** | string | 1-50B | ✅ | 영문, 숫자, 언더스코어 | - |
| **data_type** | string | 1-30B | ✅ | 소문자, 언더스코어 | - |
| **domain** | string | 1-50B | ✅ | 소문자, 하이픈 | - |
| **table_name** | string | 1-50B | ✅ | 소문자, 언더스코어 | - |
| **symbols** | array | 1-10개 | ✅ | 각 심볼 1-20자 | - |
| **period** | string | 1-10B | ❌ | Yahoo Finance 지원값 | `1mo` |
| **interval** | string | 1-10B | ❌ | Yahoo Finance 지원값 | `1d` |
| **file_format** | string | 1-20B | ❌ | json\|csv\|parquet | `json` |

### Message Attributes (선택적 메타데이터)

| Attribute 키 | 타입 | 설명 | 예시 값 | 사용 목적 |
|-------------|------|------|---------|----------|
| **correlation_id** | String | 추적용 상관관계 ID | `batch-20250909-001` | 로그 추적 |
| **source** | String | 메시지 생성자 | `orchestrator` | 디버깅 |
| **timestamp** | Number | Unix 타임스탬프 | `1694678400` | 메시지 생성 시각 |
| **retry_count** | Number | 재시도 횟수 | `0` | SQS 자동 증가 |
| **priority** | String | 우선순위 (미래 확장) | `normal\|high` | 처리 순서 제어 |

## 배치 처리

### Orchestrator → SQS (SendMessageBatch)

| 파라미터 | 값 | 제한사항 | 최적화 전략 |
|----------|-----|----------|-------------|
| **Batch Size** | 1-10개 | SQS API 제한 | 항상 최대값 사용 |
| **Total Payload** | < 256KB | 모든 메시지 합계 | 메시지별 크기 사전 계산 |
| **Retry Logic** | 1회 재시도 | 실패 메시지만 재전송 | 부분 실패 지원 |
| **Error Handling** | 즉시 실패 | 재시도 후에도 실패 시 | Lambda 예외 발생 |

### SQS → Worker Lambda (ReceiveMessage)

| Event Source Mapping 설정 | 값 | 근거 | 모니터링 지표 |
|---------------------------|-----|------|---------------|
| **Batch Size** | 1-10 | 오류 격리 vs 처리량 | Messages per invocation |
| **Maximum Batching Window** | 0-5초 | 실시간성 vs 효율성 | Batching window utilization |
| **Parallelization Factor** | 10 | SQS 처리량 최적화 | Concurrent pollers |
| **Report Batch Item Failures** | ✅ | Partial Failure 지원 | Failed vs successful items |
| **Starting Position** | LATEST | 과거 메시지 무시 | - |

## 재시도 및 오류 처리

### 재시도 흐름도 (표 형태)

| 단계 | 조건 | 액션 | Visibility Timeout | 대기 시간 |
|:---:|------|------|-------------------|-----------|
| **1** | 메시지 최초 수신 | Worker 처리 시도 | 1800초 | 즉시 |
| **2** | 처리 실패 (1회) | 큐로 반환 | 1800초 | 30분 |
| **3** | 처리 실패 (2회) | 큐로 반환 | 1800초 | 30분 |
| **4** | 처리 실패 (3회) | 큐로 반환 | 1800초 | 30분 |
| **5** | 처리 실패 (4회) | 큐로 반환 | 1800초 | 30분 |
| **6** | 처리 실패 (5회) | DLQ로 이동 | 영구 보관 | - |

### 오류 유형별 처리 매트릭스

| 오류 유형 | Receive Count | Visibility 동작 | DLQ 이동 | 알람 | 자동복구 |
|-----------|:-------------:|----------------|:-------:|:----:|:-------:|
| **JSON 파싱 오류** | 5회 후 | 정상 대기 | ✅ | ❌ | ❌ |
| **네트워크 일시 장애** | 5회 후 | 정상 대기 | ✅ | ⚠️ | ❌ |
| **API Rate Limit** | 3회 후 | 정상 대기 | ✅ | ⚠️ | ❌ |
| **IAM 권한 오류** | 1회 후 | 즉시 | ✅ | 🚨 | ❌ |
| **Worker Lambda 오류** | 5회 후 | 정상 대기 | ✅ | 🚨 | ❌ |

### Visibility Timeout 계산

| Worker 상태 | 기본 Timeout | 마진 계수 | 최종 Timeout | 근거 |
|-------------|:------------:|:---------:|:------------:|------|
| **정상 처리** | 300초 | 6배 | 1800초 | 네트워크 지연 + 재시도 마진 |
| **장시간 처리** | 600초 | 6배 | 3600초 | 대용량 데이터 처리 고려 |
| **디버깅 모드** | 900초 | 6배 | 5400초 | 개발자 수동 디버깅 시간 |

## 모니터링

### CloudWatch 표준 지표 설정

| 지표명 | 설명 | 정상 범위 | 경고 임계값 | 위험 임계값 | 알람 지연 |
|--------|------|-----------|-------------|-------------|----------|
| **ApproximateNumberOfMessages** | 대기 중인 메시지 | 0-50 | > 100 | > 500 | 5분 |
| **ApproximateNumberOfMessagesVisible** | 처리 가능한 메시지 | 0-30 | > 50 | > 200 | 5분 |
| **ApproximateAgeOfOldestMessage** | 가장 오래된 메시지 연령(초) | 0-300 | > 600 | > 1800 | 2분 |
| **NumberOfMessagesSent** | 전송된 메시지 수 | 10-1000/시간 | 급격한 변화 | 0 또는 10000+ | 10분 |
| **NumberOfMessagesReceived** | 수신된 메시지 수 | 10-1000/시간 | 급격한 변화 | 0 | 10분 |
| **NumberOfMessagesDeleted** | 삭제된 메시지 수(성공) | 95%+ | < 90% | < 80% | 15분 |

### Dead Letter Queue 전용 지표

| DLQ 지표 | 정상값 | 주의 임계값 | 위험 임계값 | 대응 시간 | 자동 조치 |
|----------|:-----:|-------------|-------------|:---------:|----------|
| **Messages In DLQ** | 0 | > 5 | > 50 | 1시간 | 개발팀 알림 |
| **DLQ Growth Rate** | 0/시간 | > 2/시간 | > 10/시간 | 30분 | 온콜 알림 |
| **DLQ Message Age** | - | > 6시간 | > 24시간 | 4시간 | 수동 처리 계획 |

### 커스텀 비즈니스 지표

| 지표 | 계산 공식 | 단위 | 목표값 | 조치 임계값 |
|------|----------|:----:|:------:|-------------|
| **처리 성공률** | (Deleted / Received) × 100 | % | > 95% | < 90% |
| **배치 효율성** | Messages per Lambda invocation | Count | 5-10 | < 2 |
| **큐 처리량** | Messages per second | Count/sec | 10-100 | < 1 |
| **지연 시간** | Age of oldest - 정상 처리시간 | Seconds | < 60 | > 300 |

## 비용 최적화

### SQS 요금 구조 (2024년 기준)

| 요금 구분 | 단가 | 최적화 전략 | 월 예상 비용 |
|----------|------|-------------|:----------:|
| **Standard Queue 요청** | $0.40/백만 요청 | 배치 처리 극대화 | $5-20 |
| **Dead Letter Queue** | 동일 요금 | DLQ 메시지 최소화 | $1-5 |
| **데이터 전송** | AWS 내부 무료 | Lambda와 동일 리전 | $0 |
| **장기 메시지 저장** | 무료 (14일) | 적시 처리 | $0 |

### 비용 절감 최적화 체크리스트

| 최적화 항목 | 현재 상태 | 목표 상태 | 절감 효과 | 구현 복잡도 |
|-------------|-----------|----------|:--------:|:---------:|
| **배치 크기 최대화** | 평균 3개 | 평균 8개 | 60% 절감 | ⭐ |
| **불필요한 속성 제거** | 5개 속성 | 2개 속성 | 10% 절감 | ⭐⭐ |
| **메시지 압축** | 미적용 | GZIP 적용 | 20% 절감 | ⭐⭐⭐ |
| **DLQ 자동 정리** | 수동 | 자동화 스크립트 | 5% 절감 | ⭐⭐⭐⭐ |

## 장애 시나리오

### 주요 장애 시나리오 및 대응

| 시나리오 | 증상 | 근본 원인 | 감지 시간 | 복구 시간 | 대응 절차 |
|----------|------|----------|:--------:|:--------:|----------|
| **Worker 전체 중단** | DLQ 급속 증가 | Lambda 오류, 권한 문제 | 5분 | 30분 | 1) Lambda 로그 확인 2) IAM 점검 3) 수동 재배포 |
| **SQS 처리 지연** | 큐 깊이 증가 | 높은 부하, 용량 부족 | 10분 | 1시간 | 1) 동시성 증가 2) 배치 크기 조정 3) Worker 확장 |
| **메시지 무한 순환** | 동일 메시지 반복 | 로직 버그, 일시적 오류 | 30분 | 2시간 | 1) 특정 메시지 추적 2) DLQ 수동 이동 3) 코드 수정 |
| **DLQ 용량 초과** | 메시지 손실 위험 | 장기간 미해결 오류 | 1시간 | 8시간 | 1) DLQ 백업 2) 일괄 재처리 3) 근본 원인 수정 |

### 복구 우선순위 매트릭스

| 우선순위 | 영향도 | 긴급도 | 대응팀 | 에스컬레이션 시간 |
|:--------:|--------|--------|--------|-------------------|
| **P0** | 전체 서비스 중단 | 즉시 해결 필요 | 온콜 엔지니어 | 15분 |
| **P1** | 부분 기능 장애 | 2시간 내 해결 | 개발팀 | 1시간 |
| **P2** | 성능 저하 | 1일 내 해결 | 개발팀 | 4시간 |
| **P3** | 경미한 이상 | 1주 내 해결 | 모니터링팀 | 24시간 |

### 재해 복구 (Disaster Recovery)

| 복구 시나리오 | RTO (복구시간) | RPO (데이터손실) | 복구 방법 | 비용 |
|--------------|:-------------:|:---------------:|----------|:----:|
| **리전 장애** | 4시간 | 1시간 | 다른 리전에 스택 재배포 | ⭐⭐⭐ |
| **AZ 장애** | 자동복구 | 0분 | SQS 자동 복제 | ⭐ |
| **큐 삭제 (실수)** | 2시간 | 큐 내 메시지 | CDK로 재생성 | ⭐⭐ |
| **메시지 대량 손실** | 8시간 | 최대 14일 | 소스 데이터부터 재수집 | ⭐⭐⭐⭐ |

---

*본 명세는 `infrastructure/pipelines/customer_data/ingestion_stack.py`의 SQS 구성을 기반으로 작성되었습니다.*