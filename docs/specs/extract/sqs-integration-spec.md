# SQS Integration â€” ë©”ì‹œì§€ í í†µí•© ëª…ì„¸

ë³¸ ë¬¸ì„œëŠ” Extract íŒŒì´í”„ë¼ì¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Amazon SQS í ì„¤ê³„, ë©”ì‹œì§€ í˜•ì‹, ë°°ì¹˜ ì²˜ë¦¬, ê·¸ë¦¬ê³  ì¬ì‹œë„ ì •ì±…ì„ ì •ì˜í•©ë‹ˆë‹¤. SQSëŠ” Orchestrator Lambdaì™€ Worker Lambda ê°„ì˜ ë¹„ë™ê¸° í†µì‹  ê³„ì¸µì„ ì œê³µí•©ë‹ˆë‹¤.

## í ì•„í‚¤í…ì²˜

Extract íŒŒì´í”„ë¼ì¸ì€ **Main Queue + Dead Letter Queue** íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

| í íƒ€ì… | ì´ë¦„ íŒ¨í„´ | ìš©ë„ | ë¼ì´í”„ì‚¬ì´í´ |
|---------|-----------|------|--------------|
| **Main Queue** | `{environment}-ingestion-queue` | ì •ìƒ ë©”ì‹œì§€ ì²˜ë¦¬ | 14ì¼ ë³´ê´€ |
| **Dead Letter Queue** | `{environment}-ingestion-dlq` | ì‹¤íŒ¨ ë©”ì‹œì§€ ê²©ë¦¬ | 14ì¼ ë³´ê´€ |

## í ì„¤ì • ëª…ì„¸

| ì„¤ì • í•­ëª© | Main Queue | Dead Letter Queue | ê·¼ê±° |
|----------|------------|-------------------|------|
| **Queue Type** | Standard | Standard | ìˆœì„œ ë³´ì¥ ë¶ˆí•„ìš” |
| **Visibility Timeout** | 1800ì´ˆ (30ë¶„) | 300ì´ˆ (5ë¶„) | Worker ì²˜ë¦¬ì‹œê°„ vs ìˆ˜ë™ ì²˜ë¦¬ |
| **Message Retention** | 14ì¼ | 14ì¼ | AWS ê¸°ë³¸ê°’ ìœ ì§€ |
| **Receive Wait Time** | 0ì´ˆ (ë‹¨ì‹œê°„ í´ë§) | 20ì´ˆ (ì¥ì‹œê°„ í´ë§) | Lambda ìµœì í™” vs ìˆ˜ë™ ì²˜ë¦¬ |
| **Max Receive Count** | 5íšŒ | âˆ | DLQ ì´ë™ ì¡°ê±´ vs ì˜êµ¬ ë³´ê´€ |
| **Max Message Size** | 256KB | 256KB | SQS ê¸°ë³¸ ì œí•œ |
| **KMS Encryption** | âœ… (ê¸°ë³¸í‚¤) | âœ… (ê¸°ë³¸í‚¤) | ì €ì¥ ë°ì´í„° ì•”í˜¸í™” |

### í™˜ê²½ë³„ ì„¤ì •

| í™˜ê²½ | Main Queue Timeout | DLQ ì•ŒëŒ ì„ê³„ê°’ | Batch Size | ê·¼ê±° |
|------|-------------------|-----------------|------------|------|
| **dev** | 1800ì´ˆ | 10ê°œ | 1-5 | ë””ë²„ê¹… í¸ì˜ì„± |
| **staging** | 1800ì´ˆ | 5ê°œ | 5-10 | ìš´ì˜ í™˜ê²½ ìœ ì‚¬ |
| **prod** | 1800ì´ˆ | 1ê°œ | 10 | ìµœëŒ€ ì„±ëŠ¥ + ì¦‰ì‹œ ì•ŒëŒ |

## ë©”ì‹œì§€ í˜•ì‹

### ë©”ì‹œì§€ êµ¬ì¡°

| êµ¬ì„± ìš”ì†Œ | í¬ê¸° ì œí•œ | í˜•ì‹ | ì„¤ëª… |
|----------|-----------|------|------|
| **Message Body** | 256KB | JSON ë¬¸ìì—´ | ì‹¤ì œ í˜ì´ë¡œë“œ ë°ì´í„° |
| **Message Attributes** | 10ê°œ, ê° 256B | Key-Value | ë©”íƒ€ë°ì´í„° (ì„ íƒ) |
| **Message ID** | - | UUID | SQS ìë™ ìƒì„± |
| **Receipt Handle** | - | String | ë©”ì‹œì§€ ì‚­ì œìš© í•¸ë“¤ |

### Message Body í•„ë“œ

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ê²€ì¦ ê·œì¹™ | ê¸°ë³¸ê°’ |
|------|------|:---:|----------|--------|
| **data_source** | string | âœ… | ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ | - |
| **data_type** | string | âœ… | ì†Œë¬¸ì, ì–¸ë”ìŠ¤ì½”ì–´ | - |
| **domain** | string | âœ… | ì†Œë¬¸ì, í•˜ì´í”ˆ | - |
| **table_name** | string | âœ… | ì†Œë¬¸ì, ì–¸ë”ìŠ¤ì½”ì–´ | - |
| **symbols** | array | âœ… | ê° ì‹¬ë³¼ 1-20ì | - |
| **period** | string | âŒ | Yahoo Finance ì§€ì›ê°’ | `1mo` |
| **interval** | string | âŒ | Yahoo Finance ì§€ì›ê°’ | `1d` |
| **file_format** | string | âŒ | json\|csv\|parquet | `json` |

## ë°°ì¹˜ ì²˜ë¦¬

### Orchestrator â†’ SQS (SendMessageBatch)

| íŒŒë¼ë¯¸í„° | ê°’ | ì œí•œì‚¬í•­ | ìµœì í™” ì „ëµ |
|----------|-----|----------|-------------|
| **Batch Size** | 1-10ê°œ | SQS API ì œí•œ | í•­ìƒ ìµœëŒ€ê°’ ì‚¬ìš© |
| **Total Payload** | < 256KB | ëª¨ë“  ë©”ì‹œì§€ í•©ê³„ | ë©”ì‹œì§€ë³„ í¬ê¸° ì‚¬ì „ ê³„ì‚° |
| **Retry Logic** | 1íšŒ ì¬ì‹œë„ | ì‹¤íŒ¨ ë©”ì‹œì§€ë§Œ ì¬ì „ì†¡ | ë¶€ë¶„ ì‹¤íŒ¨ ì§€ì› |

### SQS â†’ Worker Lambda (ReceiveMessage)

| Event Source Mapping ì„¤ì • | ê°’ | ê·¼ê±° |
|---------------------------|-----|------|
| **Batch Size** | 1-10 | ì˜¤ë¥˜ ê²©ë¦¬ vs ì²˜ë¦¬ëŸ‰ |
| **Maximum Batching Window** | 0-5ì´ˆ | ì‹¤ì‹œê°„ì„± vs íš¨ìœ¨ì„± |
| **Parallelization Factor** | 10 | SQS ì²˜ë¦¬ëŸ‰ ìµœì í™” |
| **Report Batch Item Failures** | âœ… | Partial Failure ì§€ì› |

## ì¬ì‹œë„ ë° ì˜¤ë¥˜ ì²˜ë¦¬

### ì¬ì‹œë„ íë¦„

| ë‹¨ê³„ | ì¡°ê±´ | ì•¡ì…˜ | Visibility Timeout | ëŒ€ê¸° ì‹œê°„ |
|:---:|------|------|-------------------|-----------|
| **1** | ë©”ì‹œì§€ ìµœì´ˆ ìˆ˜ì‹  | Worker ì²˜ë¦¬ ì‹œë„ | 1800ì´ˆ | ì¦‰ì‹œ |
| **2** | ì²˜ë¦¬ ì‹¤íŒ¨ (1íšŒ) | íë¡œ ë°˜í™˜ | 1800ì´ˆ | 30ë¶„ |
| **3** | ì²˜ë¦¬ ì‹¤íŒ¨ (2íšŒ) | íë¡œ ë°˜í™˜ | 1800ì´ˆ | 30ë¶„ |
| **4** | ì²˜ë¦¬ ì‹¤íŒ¨ (3íšŒ) | íë¡œ ë°˜í™˜ | 1800ì´ˆ | 30ë¶„ |
| **5** | ì²˜ë¦¬ ì‹¤íŒ¨ (4íšŒ) | íë¡œ ë°˜í™˜ | 1800ì´ˆ | 30ë¶„ |
| **6** | ì²˜ë¦¬ ì‹¤íŒ¨ (5íšŒ) | DLQë¡œ ì´ë™ | ì˜êµ¬ ë³´ê´€ | - |

### ì˜¤ë¥˜ ìœ í˜•ë³„ ì²˜ë¦¬

| ì˜¤ë¥˜ ìœ í˜• | Receive Count | DLQ ì´ë™ | ì•ŒëŒ | ìë™ë³µêµ¬ |
|-----------|:-------------:|:-------:|:----:|:-------:|
| **JSON íŒŒì‹± ì˜¤ë¥˜** | 5íšŒ í›„ | âœ… | âŒ | âŒ |
| **ë„¤íŠ¸ì›Œí¬ ì¼ì‹œ ì¥ì• ** | 5íšŒ í›„ | âœ… | âš ï¸ | âŒ |
| **API Rate Limit** | 3íšŒ í›„ | âœ… | âš ï¸ | âŒ |
| **IAM ê¶Œí•œ ì˜¤ë¥˜** | 1íšŒ í›„ | âœ… | ğŸš¨ | âŒ |
| **Worker Lambda ì˜¤ë¥˜** | 5íšŒ í›„ | âœ… | ğŸš¨ | âŒ |

## ëª¨ë‹ˆí„°ë§

### CloudWatch í‘œì¤€ ì§€í‘œ

| ì§€í‘œëª… | ì •ìƒ ë²”ìœ„ | ê²½ê³  ì„ê³„ê°’ | ìœ„í—˜ ì„ê³„ê°’ | ì•ŒëŒ ì§€ì—° |
|--------|-----------|-------------|-------------|----------|
| **ApproximateNumberOfMessages** | 0-50 | > 100 | > 500 | 5ë¶„ |
| **ApproximateAgeOfOldestMessage** | 0-300ì´ˆ | > 600ì´ˆ | > 1800ì´ˆ | 2ë¶„ |
| **NumberOfMessagesSent** | 10-1000/ì‹œê°„ | ê¸‰ê²©í•œ ë³€í™” | 0 ë˜ëŠ” 10000+ | 10ë¶„ |
| **NumberOfMessagesDeleted** | 95%+ | < 90% | < 80% | 15ë¶„ |

### Dead Letter Queue ì§€í‘œ

| DLQ ì§€í‘œ | ì •ìƒê°’ | ì£¼ì˜ ì„ê³„ê°’ | ìœ„í—˜ ì„ê³„ê°’ | ëŒ€ì‘ ì‹œê°„ |
|----------|:-----:|-------------|-------------|:---------:|
| **Messages In DLQ** | 0 | > 5 | > 50 | 1ì‹œê°„ |
| **DLQ Growth Rate** | 0/ì‹œê°„ | > 2/ì‹œê°„ | > 10/ì‹œê°„ | 30ë¶„ |
| **DLQ Message Age** | - | > 6ì‹œê°„ | > 24ì‹œê°„ | 4ì‹œê°„ |

---

*ë³¸ ëª…ì„¸ëŠ” `infrastructure/pipelines/customer_data/ingestion_stack.py`ì˜ SQS êµ¬ì„±ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*